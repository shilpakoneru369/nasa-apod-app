<!DOCTYPE html>
<html>
  <head>
    <title>nasa apod viewer</title>

    <!-- main stylesheet for the whole app -->
    <link rel="stylesheet" href="/css/styles.css" />

    <!-- google font so everything matches our design -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- simple sticky header with the app title and a home link -->
    <header>
      <h1>nasa apod viewer</h1>
      <nav>
        <a href="/">home</a>
      </nav>
    </header>

    <!-- main content area for the apod page -->
    <main>
      <!-- section where the user picks a date to look up an apod -->
      <section class="search-section">
        <h2>choose a date</h2>
        <p class="section-caption">
          nasa releases a new astronomy picture of the day every 24 hours. pick
          a date to see what the universe looked like on that day!
        </p>

        <!-- form that posts the selected date to /apod/fetch -->
        <form action="/apod/fetch" method="POST">
          <label for="date">date:</label>
          <input type="date" id="date" name="date" required />
          <button type="submit">get picture</button>
        </form>
      </section>

      <!-- section that shows the current picture of the day (if one is selected) -->
      <section class="apod-section">
        <h2>picture of the day</h2>

        <!-- if we have an apod object, show the card; otherwise show the empty state -->
        <% if (apod) { %>
        <div class="apod-card">
          <div class="apod-card-header">
            <!-- top row metadata: formatted date pill -->
            <div class="apod-meta">
              <span class="pill pill-date">
                <%= apod.displayDate || apod.date %>
              </span>
            </div>

            <!-- main title for the picture (we add "image:" to make it clear) -->
            <h2 class="apod-title">Image: <%= apod.title %></h2>
          </div>

          <!-- if nasa returned an image, we show it directly -->
          <% if (apod.mediaType === "image") { %>
          <img src="<%= apod.imageUrl %>" alt="astronomy picture of the day" />
          <% } else { %>
          <!-- if nasa returned a video, we just give a link to open it in a new tab -->
          <div class="video-placeholder">
            <p>this apod is a video. you can open it in a new tab:</p>
            <a
              href="<%= apod.imageUrl %>"
              target="_blank"
              rel="noopener noreferrer"
            >
              open nasa apod video
            </a>
          </div>
          <% } %>

          <!-- nasaâ€™s explanation text about the picture or video -->
          <p class="explanation"><%= apod.explanation %></p>

          <!-- form to save the currently viewed apod into mongodb as a favorite -->
          <form class="apod-actions" action="/apod/save" method="POST">
            <input type="hidden" name="date" value="<%= apod.date %>" />
            <input type="hidden" name="title" value="<%= apod.title %>" />
            <input
              type="hidden"
              name="explanation"
              value="<%= apod.explanation %>"
            />
            <input
              type="hidden"
              name="mediaType"
              value="<%= apod.mediaType %>"
            />
            <input type="hidden" name="imageUrl" value="<%= apod.imageUrl %>" />
            <input
              type="hidden"
              name="hdImageUrl"
              value="<%= apod.hdImageUrl %>"
            />
            <button type="submit">save to favorites</button>
          </form>
        </div>

        <% } else { %>
        <div class="empty-state">
          <p>no picture selected yet.</p>
          <p>choose a date above to load your first nasa apod!</p>
        </div>
        <% } %>
      </section>

      <!-- section that lists all apods the user has saved to favorites -->
      <section class="favorites-section">
        <h2>saved favorites</h2>
        <p class="section-caption">you can remove items at any time.</p>

        <% if (favorites && favorites.length > 0) { %>
        <ul class="favorites-list">

          <% favorites.forEach(function (fav) { 
               // format the favorite's date from yyyy-mm-dd -> mm/dd/yyyy
               let favDisplayDate = fav.date;
               if (fav.date && typeof fav.date === "string") {
                 const parts = fav.date.split("-");
                 if (parts.length === 3) {
                   favDisplayDate = parts[1] + "/" + parts[2] + "/" + parts[0];
                 }
               }
          %>

          <li class="favorite-item">
            <div class="favorite-header">
              <span class="pill pill-date"><%= favDisplayDate %></span>
              <h3><%= fav.title %></h3>
            </div>

            <% if (fav.mediaType === "image" && fav.imageUrl) { %>
            <img src="<%= fav.imageUrl %>" alt="favorite apod" />
            <% } %>

            <form
              class="favorite-actions"
              action="/apod/delete/<%= fav._id %>"
              method="POST"
            >
              <button type="submit">remove</button>
            </form>
          </li>

          <% }); %>

        </ul>

        <% } else { %>
        <div class="empty-state">
          <p>you haven't saved any favorites yet.</p>
          <p>save a few apods you like and they'll show up here!</p>
        </div>
        <% } %>
      </section>
    </main>
  </body>
</html>